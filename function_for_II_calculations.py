from typing import Dict, List, Tuple
from Table_class import Table1D, Table2D
from bisect import bisect_right


def z_b(z,b):
    return z/b


def a_b(a,b):
    return a/b


def p0(F,a,b):
    return F/(a*b)


def kh(z: float, b:float) -> float:
    x = z_b(z,b)
    intervals = [(0.0,0.25),(0.25,0.5),(0.5,1.5),(1.5,3.5),(3.5,5.0),(5.0,float("inf"))]
    vals = [1.35, 1.25, 1.15, 1.10, 1.05, 1.00]
    kh_table = Table1D.from_intervals(intervals, vals)
    return kh_table.lookup(x)


def kmui(z: float, b: float, soil_type: str) -> float:

    # ---- Константы таблицы k_μi ----
    KMUI_TABLE: Dict[str, List[float]] = {
        "крупнообломочные": [1.35, 1.33, 1.31, 1.29, 1.29, 1.28],
        "песчаные и супеси": [1.35, 1.35, 1.35, 1.35, 1.35, 1.35],
        "суглинки": [1.36, 1.42, 1.45, 1.52, 1.53, 1.54],
        "глины": [1.55, 1.79, 1.96, 2.15, 2.22, 2.28],
    }

    SOIL_ALIASES: Dict[str, str] = {
        "крупнообломочные": "крупнообломочные",
        "крупнообломочных": "крупнообломочные",
        "песчаные и супеси": "песчаные и супеси",
        "песчаных и супесей": "песчаные и супеси",
        "суглинки": "суглинки",
        "суглинков": "суглинки",
        "глины": "глины",
        "глин": "глины",
    }

    # Нижние границы интервалов z/b (последний интервал тянется до +∞)
    # Соответствуют строкам таблицы: [0, 0.25, 0.5, 1.5, 3.5, 5.0]
    ZB_BOUNDS: List[float] = [0.0, 0.25, 0.5, 1.5, 3.5, 5.0]
    """
    Возвращает k_{μi} по z/b и типу грунта.
    Интервалы по z/b: [0,0.25), [0.25,0.5), [0.5,1.5), [1.5,3.5), [3.5,5.0), [5.0, +∞).
    """
    z_over_b = z_b(z, b)
    if z_over_b < 0:
        raise ValueError("z/b должно быть ≥ 0.")

    key = SOIL_ALIASES.get(soil_type.strip().lower())
    if key is None or key not in KMUI_TABLE:
        allowed = ", ".join(KMUI_TABLE.keys())
        raise ValueError(f"Неизвестный тип грунта: {soil_type!r}. Допустимо: {allowed}")

    # индекс строки: ищем правую позицию и берём предыдущую
    # для z/b=5.0 попадём в последний индекс (интервал [5.0, +∞))
    i = bisect_right(ZB_BOUNDS, z_over_b) - 1
    if i < 0:
        i = 0
    elif i >= len(ZB_BOUNDS):
        i = len(ZB_BOUNDS) - 1
    return KMUI_TABLE[key][i]


def ki(a: float, b: float, z: float) -> float:
    if z < 0:
        z = 0
    a_over_b = a_b(a,b)
    z_over_b = z_b(z,b)
    KI_Z_ROWS = [
        # пример начала (замени на полный список)
        0.0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4, 1.6, 1.8, 2.0,
        2.5, 3.0, 3.5, 4.0, 6.0, 8.0, 12.0, 16.0, 20.0
    ]

    # Список A/B по столбцам (в точности как в заголовках таблицы)
    KI_A_COLS = [1.0, 1.4, 1.8, 2.4, 3.0, 3.2, 5.0, 10.0]

    # Матрица значений k_i размера [len(KI_Z_ROWS)] x [len(KI_A_COLS)]
    # Каждая внутренняя строка — это значения по всем столбцам A/B для одного Z/B.
    # ↓↓↓ ВСТАВЬ СВОИ ЧИСЛА ИЗ ТАБЛИЦЫ 7.7 ↓↓↓
    KI_VALS = [
        # z/b = 0.0
        [0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
        # z/b = 0.2
        [0.100, 0.100, 0.100, 0.100, 0.100, 0.100, 0.100, 0.104],
        # z/b = 0.4
        [0.200, 0.200, 0.200, 0.200, 0.200, 0.200, 0.200, 0.208],
        # z/b = 0.6
        [0.299, 0.300, 0.300, 0.300, 0.300, 0.300, 0.300, 0.311],
        # z/b = 0.8
        [0.380, 0.394, 0.397, 0.397, 0.397, 0.397, 0.397, 0.416],
        # z/b = 1.0
        [0.472, 0.486, 0.489, 0.489, 0.487, 0.486, 0.486, 0.520],
        # z/b = 1.2
        [0.449, 0.538, 0.566, 0.565, 0.565, 0.567, 0.567, 0.621],
        # z/b = 1.4
        [0.542, 0.592, 0.618, 0.635, 0.640, 0.640, 0.640, 0.721],
        # z/b = 1.6
        [0.610, 0.643, 0.666, 0.695, 0.705, 0.706, 0.706, 0.821],
        # z/b = 1.8
        [0.678, 0.676, 0.717, 0.757, 0.768, 0.768, 0.776, 0.921],
        # z/b = 2.0
        [0.706, 0.679, 0.748, 0.795, 0.810, 0.828, 0.832, 1.017],
        # z/b = 2.5
        [0.708, 0.846, 0.837, 0.962, 1.023, 1.028, 1.082, 1.200],
        # z/b = 3.0
        [0.732, 0.846, 0.927, 1.016, 1.125, 1.121, 1.231, 1.230],
        # z/b = 3.5
        [0.760, 0.846, 0.961, 1.015, 1.123, 1.125, 1.203, 1.207],
        # z/b = 4.0
        [0.784, 0.904, 1.007, 1.091, 1.203, 1.206, 1.314, 1.341],
        # z/b = 6.0
        [0.794, 0.933, 1.037, 1.151, 1.257, 1.258, 1.384, 1.514],
        # z/b = 8.0
        [0.824, 0.963, 1.071, 1.207, 1.324, 1.329, 1.459, 1.699],
        # z/b = 12.0
        [0.850, 1.011, 1.137, 1.233, 1.351, 1.357, 1.523, 1.925],
        # z/b = 16.0
        [0.850, 1.011, 1.137, 1.284, 1.430, 1.469, 1.645, 2.095],
        # z/b = 20.0
        [0.857, 1.021, 1.149, 1.300, 1.451, 1.679, 2.236, 2.236],
    ]
    tab2 = Table2D(KI_Z_ROWS, KI_A_COLS, KI_VALS)
    ki = tab2.lookup(z_over_b,a_over_b,interpolate=True, clamp=True)
    return ki